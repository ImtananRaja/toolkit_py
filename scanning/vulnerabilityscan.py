#!/usr/bin/python

import socket
# os import to help us check if vulnerabilty file exists
# also help read from it
import os
# sys import to help check arguments for the program
import sys


def returnbanner(ip, port):
    try:
        # timeout if no response in 2 seconds
        socket.setdefaulttimeout(2)
        # create a socket object
        s = socket.socket()
        # connect to the ip and port
        s.connect((ip, port))
        # what we receive from the host when we scan
        # and the number of bytes to receive
        banner = s.recv(1024)
        return banner
    except:
        return

def checkvulns(banner, fileName):
    # open the file to read
    f = open(fileName, "r")

    for line in f.readlines():
        # strip the new line
        if line.strip("\n") in banner:
            print "[+] Server is vulnerable: " + banner.strip("\n")


def main():
    # check if there is correct number of args passed
    # arg[0] file being executed
    # arg[1] file being passed in
    if len(sys.argv) == 2:
        filename = sys.argv[1]
        # check if file exists
        if not os.path.isfile(filename):
            print "[-] file doesn't exist"
            exit(0)
        # check if you are allowed access to the file
        if not os.access(filename, os.R_OK):
            print "[-] Access is not allowed to the file"
            exit(0)
    else:
        print "[-] Usage: " + str(sys.argv[0]) + "<vuln FileName>"
        exit(0)

    portList = [22, 21, 111, 3306]
    machineList = [1, 3, 20, 21, 25, 29, 30, 33, 35, 36, 38, 50, 201, 204, 173]
    for machine in machineList:
        # this should be changed to the IP you want
        ip = "192.168.1." + str(machine)
        print ip + "\n"
        for port in portList:
            banner = returnbanner(ip, port)
            if banner:
                print "[+]" + ip + "/" + str(port) + ": " + banner
                # check if the banner is in our vulnerable banner list
                checkvulns(banner, filename)


if __name__ == '__main__':
    main()

# to run use
# python vulnerabilityscan.py vulBanners.txt